import requests
import json
import time

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–ó–∞–º–µ–Ω–∏—Ç–µ —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏) ---
ACCESS_TOKEN = "–í–ê–®_–î–û–õ–ì–û–ñ–ò–í–£–©–ò–ô_–¢–û–ö–ï–ù"
INSTAGRAM_ACCOUNT_ID = "–í–ê–®_INSTAGRAM_BUSINESS_ID"
IMAGE_URL = "https://example.com/images/new_product.jpg"
CAPTION = "üî• –ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è –æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ç—Ä–µ–Ω–¥–∞—Ö! –ß–∏—Ç–∞–π—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ. #–±–∞–Ω–∫–∏–Ω–≥ #—Ñ–∏–Ω–∞–Ω—Å—ã"
# ---------------------------------------------

def post_instagram_image(account_id, access_token, image_url, caption):
    """
    –°–æ–∑–¥–∞–µ—Ç –º–µ–¥–∏–∞–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∑–∞—Ç–µ–º –ø—É–±–ª–∏–∫—É–µ—Ç –µ–≥–æ –≤ Instagram.
    
    –≠—Ç–∞–ø—ã: 
    1. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (Media Container)
    2. –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    3. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    """
    
    # 1. –°–û–ó–î–ê–ù–ò–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ê
    print("–≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–¥–∏–∞–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞...")
    
    creation_url = f"https://graph.facebook.com/v19.0/{account_id}/media"
    payload = {
        'image_url': image_url,
        'caption': caption,
        'access_token': access_token
    }

    try:
        response = requests.post(creation_url, data=payload)
        response.raise_for_status()
        
        container_id = response.json().get('id')
        if not container_id:
            raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.")
            
        print(f"‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–∑–¥–∞–Ω. ID: {container_id}")
        
        # 2. –û–ñ–ò–î–ê–ù–ò–ï –ì–û–¢–û–í–ù–û–°–¢–ò (Media Publishing Status)
        # API —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–æ–∂–¥–∞—Ç—å, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è
        print("–≠—Ç–∞–ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–æ–∂–∏–¥–∞–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥)...")
        time.sleep(10) # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É

        status_url = f"https://graph.facebook.com/v19.0/{container_id}"
        status_params = {
            'fields': 'status_code',
            'access_token': access_token
        }
        
        while True:
            status_response = requests.get(status_url, params=status_params)
            status_response.raise_for_status()
            status_code = status_response.json().get('status_code')
            
            if status_code == 'FINISHED':
                print("‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–æ—Ç–æ–≤ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.")
                break
            elif status_code == 'IN_PROGRESS' or status_code == 'PROCESSING':
                print("‚è≥ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –∂–¥–µ–º –µ—â–µ 5 —Å–µ–∫—É–Ω–¥...")
                time.sleep(5)
            else:
                raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: {status_code}")


        # 3. –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø
        print("–≠—Ç–∞–ø 3: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ—Å—Ç–∞...")
        
        publish_url = f"https://graph.facebook.com/v19.0/{account_id}/media_publish"
